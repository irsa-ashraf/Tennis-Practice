<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>NYC Tennis Courts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Leaflet CSS for maps -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
</head>
<body>

  <h1>NYC Tennis Courts</h1>
  <p>See the nearest tennis courts</p>

  <div id="status" style="font-size:12px; opacity:0.8; margin-top:4px; color:#e6a700;"></div>

  <!-- Controls -->
  <div>
    <button id="btnLocate">Use my location</button>
    <input id="address" type="text" placeholder="Enter an address, e.g. 399 Park Avenue, NYC" style="width:260px;">
    <button id="btnSearch">Search</button>
  </div>

  <!-- Resolved address label -->
  <div style="font-size:12px; opacity:0.8; margin-top:4px;">
    <span id="addrLabel"></span>
  </div>

  <!-- Map container -->
  <div id="map" style="height:400px; margin-top:8px;"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // Base URL for API calls. If served by FastAPI, keep "". If opened directly, fallback to localhost.
    const BASE_URL = location.origin.startsWith('http') ? "" : "http://127.0.0.1:8000";

    const statusEl = document.getElementById('status');
    const addrLabel = document.getElementById('addrLabel');

    // Initialize the map
    const map = L.map('map').setView([40.7128, -74.0060], 12); // NYC coords

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // User marker
    let userMarker = null;
    function setUserMarker(lat, lon, label = 'You are here') {
      if (userMarker) userMarker.remove();
      userMarker = L.marker([lat, lon]).addTo(map).bindPopup(label);
      map.setView([lat, lon], 14);
    }

    // Court markers
    let courtMarkers = [];
    function clearCourts() {
      courtMarkers.forEach(m => m.remove());
      courtMarkers = [];
    }
    function addCourts(list) {
      clearCourts();
      const bounds = [];
      list.forEach(c => {
        const name = c.Name ?? "";
        const borough = c.Borough ?? "";
        const rawDist = c.Distance_Km;
        const dist = (typeof rawDist === 'number')
          ? `${rawDist.toFixed(2)} km`
          : (rawDist ?? "");
        const lat = c.Lat;
        const lon = c.Lon;
        const id = c.Court_Id;

        const html = `
          <div style="font-size:12px;line-height:1.3">
            <b>${name}</b><br>
            ${borough ? `${borough}<br>` : ""}
            ${dist ? `${dist}<br>` : ""}
            <a href="/courts/${id}" target="_blank">Details</a>
          </div>`;
        const m = L.marker([lat, lon]).addTo(map).bindPopup(html);
        courtMarkers.push(m);
        bounds.push([lat, lon]);
      });
      if (bounds.length) {
        if (userMarker) bounds.push(userMarker.getLatLng());
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    // Fetch nearest courts
    async function fetchNearest(lat, lon) {
      const url = `${BASE_URL}/nearest?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&limit=10`;
      try {
        console.log("[nearest] GET", url);
        const res = await fetch(url);
        const text = await res.text();
        if (!res.ok) {
          console.error("[nearest] HTTP", res.status, text);
          statusEl.textContent = `Nearest failed: HTTP ${res.status}`;
          throw new Error(`Nearest lookup failed: ${res.status}`);
        }
        const data = JSON.parse(text); // { count, results: [...] }
        console.log("[nearest] OK", data);
        statusEl.textContent = "";
        addCourts(data.results || []);
      } catch (e) {
        console.error("[nearest] EXC", e);
        statusEl.textContent = "Failed to load nearby courts. See console for details.";
        alert('Failed to load nearby courts.');
      }
    }

    // Reverse geocode current coords -> label
    async function reverseGeocode(lat, lon) {
      try {
        const res = await fetch(`${BASE_URL}/reverse_geocode`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat, lon })
        });
        if (!res.ok) { addrLabel.textContent = ''; return; }
        const data = await res.json(); // { display_name }
        addrLabel.textContent = data.display_name || '';
      } catch {
        addrLabel.textContent = '';
      }
    }

    // Geolocate and drop a marker + load nearest + label
    document.getElementById('btnLocate').addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('Geolocation not supported by your browser.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          setUserMarker(latitude, longitude);
          reverseGeocode(latitude, longitude);
          fetchNearest(latitude, longitude);
        },
        (err) => {
          console.error(err);
          alert('Could not get your location.');
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });

    // Address search (click + Enter)
    document.getElementById('btnSearch').addEventListener('click', onSearch);
    document.getElementById('address').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        onSearch();
      }
    });

    async function onSearch() {
      const address = document.getElementById('address').value.trim();
      if (!address) return;

      try {
        const res = await fetch(`${BASE_URL}/geocode`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address })
        });
        if (!res.ok) {
          alert('Address not found');
          return;
        }
        const data = await res.json(); // { lat, lon, display_name }
        setUserMarker(data.lat, data.lon, data.display_name || 'Selected location');
        if (userMarker) userMarker.openPopup();
        addrLabel.textContent = data.display_name || '';
        fetchNearest(data.lat, data.lon);
      } catch (e) {
        console.error(e);
        alert('Geocoding request failed.');
      }
    }

    console.log("Map initialized with address label + reverse geocoding + enter-to-search + distance formatting");
  </script>

</body>
</html>
